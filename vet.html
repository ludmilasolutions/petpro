<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VetApp - Veterinaria</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="manifest" href="pwa-manifest.json">
</head>
<body class="dashboard">
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>VetApp ğŸ¥</h2>
            <p class="user-role" id="vetStatus">PerÃ­odo de prueba</p>
        </div>
        
        <div class="user-info">
            <div class="user-avatar">ğŸ¥</div>
            <div>
                <h4 id="vetNombre">Mi Veterinaria</h4>
                <p id="vetPlan">Plan: Prueba 30 dÃ­as</p>
            </div>
        </div>
        
        <ul class="nav-menu">
            <li><a href="#dashboard" class="active"><span>ğŸ“Š</span> Dashboard</a></li>
            <li><a href="#turnos-hoy"><span>ğŸ“…</span> Turnos de hoy</a></li>
            <li><a href="#buscar-mascotas"><span>ğŸ”</span> Buscar mascotas</a></li>
            <li><a href="#mascotas-autorizadas"><span>ğŸ¶</span> Mascotas autorizadas</a></li>
            <li><a href="#cargar-historial"><span>ğŸ“‹</span> Cargar historial</a></li>
            <li><a href="#usuarios"><span>ğŸ‘¥</span> Usuarios internos</a></li>
            <li><a href="#metricas"><span>ğŸ“ˆ</span> MÃ©tricas</a></li>
            <li><a href="#pago"><span>ğŸ’°</span> SuscripciÃ³n</a></li>
        </ul>
        
        <div style="margin-top: auto;">
            <button onclick="logout()" class="btn btn-secondary">Cerrar SesiÃ³n</button>
        </div>
    </nav>
    
    <main class="main-panel">
        <!-- Onboarding guiado -->
        <div id="onboarding" class="card">
            <h3>ğŸ¯ Bienvenida a VetApp</h3>
            <p>Completa estos pasos para configurar tu veterinaria:</p>
            
            <div class="steps">
                <div class="step active">
                    <span class="step-number">1</span>
                    <p>Completar datos de la veterinaria</p>
                    <button onclick="completarDatos()" class="btn btn-small btn-primary">Completar</button>
                </div>
                
                <div class="step">
                    <span class="step-number">2</span>
                    <p>Crear primer usuario interno</p>
                </div>
                
                <div class="step">
                    <span class="step-number">3</span>
                    <p>Registrar primera mascota (demo)</p>
                </div>
                
                <div class="step">
                    <span class="step-number">4</span>
                    <p>Crear primer turno</p>
                </div>
            </div>
        </div>
        
        <!-- BÃºsqueda de mascotas -->
        <div class="card">
            <h3>ğŸ” Buscar mascotas</h3>
            <div class="grid-4">
                <input type="text" class="form-control" placeholder="Nombre de mascota" id="buscarMascota">
                <input type="text" class="form-control" placeholder="Nombre del dueÃ±o" id="buscarDueno">
                <input type="tel" class="form-control" placeholder="TelÃ©fono" id="buscarTelefono">
                <button class="btn btn-primary" onclick="buscarMascotas()">Buscar</button>
            </div>
            
            <div id="resultadosBusqueda" class="mt-3"></div>
        </div>
        
        <!-- Turnos del dÃ­a -->
        <div class="card">
            <h3>ğŸ“… Turnos de hoy</h3>
            <table class="table">
                <thead>
                    <tr>
                        <th>Hora</th>
                        <th>Mascota</th>
                        <th>DueÃ±o</th>
                        <th>Motivo</th>
                        <th>Estado</th>
                    </tr>
                </thead>
                <tbody id="turnosHoy">
                    <!-- DinÃ¡mico -->
                </tbody>
            </table>
        </div>
        
        <!-- Panel de pago -->
        <div id="pagoPanel" class="card" style="display: none;">
            <h3>ğŸ’° SuscripciÃ³n VetApp</h3>
            <p>Precio Ãºnico: $50.000/mes - Primer mes gratis</p>
            <button id="pagoButton" class="btn btn-success">Activar suscripciÃ³n</button>
        </div>
    </main>
    
    <script src="firebase-config.js"></script>
    <script src="auth.js"></script>
    <script src="turnos.js"></script>
    <script>
        auth.onAuthStateChanged(async user => {
            if (!user) {
                window.location.href = 'index.html';
            } else {
                await verificarVeterinaria(user.uid);
            }
        });
        
        async function verificarVeterinaria(uid) {
            // Verificar si la veterinaria estÃ¡ registrada
            const vetDoc = await db.collection('veterinarias').doc(uid).get();
            
            if (!vetDoc.exists) {
                // Redirigir a setup
                window.location.href = 'setup.html';
            } else {
                const data = vetDoc.data();
                document.getElementById('vetNombre').textContent = data.nombre;
                
                if (data.estado === 'trial') {
                    const diasRestantes = calcularDiasRestantes(data.fechaRegistro);
                    document.getElementById('vetStatus').textContent = `Prueba - ${diasRestantes} dÃ­as restantes`;
                    
                    if (diasRestantes <= 0) {
                        document.getElementById('pagoPanel').style.display = 'block';
                    }
                }
            }
        }
        
        function calcularDiasRestantes(fechaRegistro) {
            const hoy = new Date();
            const registro = fechaRegistro.toDate();
            const diferencia = 30 - Math.floor((hoy - registro) / (1000 * 60 * 60 * 24));
            return Math.max(0, diferencia);
        }
        
        function logout() {
            firebase.auth().signOut().then(() => {
                window.location.href = 'index.html';
            });
        }
    </script>
</body>
</html>
